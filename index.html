<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Create Ticket - Goodwill</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    },
                    colors: {
                        'goodwill-blue': '#4F46E5',
                        'goodwill-dark-blue': '#3730A3',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom toolbar style */
        .ql-toolbar {
            border-radius: 8px 8px 0 0;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
        }

        /* Custom editor container */
        .ql-container {
            border-radius: 0 0 8px 8px;
            border: 1px solid #d1d5db;
            border-top: none;
            background-color: white;
            min-height: 150px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Custom buttons */
        .ql-toolbar .ql-stroke {
            stroke: #4b5563;
        }

        .ql-toolbar .ql-fill {
            fill: #4b5563;
        }

        .ql-toolbar button:hover .ql-stroke,
        .ql-toolbar button:focus .ql-stroke,
        .ql-toolbar button.ql-active .ql-stroke {
            stroke: #1d4ed8;
        }

        .ql-toolbar button:hover .ql-fill,
        .ql-toolbar button:focus .ql-fill,
        .ql-toolbar button.ql-active .ql-fill {
            fill: #1d4ed8;
        }

        /* Custom dropdowns */
        .ql-picker-label {
            color: #4b5563;
        }

        .ql-picker-options {
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .ql-editor::before {
            content: attr(data-placeholder);
            color: #999;
            position: absolute;
            pointer-events: none;
        }

        .ql-editor.ql-blank::before {
            content: attr(data-placeholder);
        }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen">
    <!-- Main Container -->
    <div class="min-h-screen bg-gray-100 py-4 px-4 sm:py-8 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <!-- Card Container -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="flex justify-center">
                        <button id="createTab"
                            class="px-6 py-4 text-sm font-medium text-white bg-goodwill-blue border-b-2 border-goodwill-blue focus:outline-none transition-colors duration-200">
                            Create Ticket
                        </button>
                        <button id="viewTicketsTab"
                            class="px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 focus:outline-none transition-colors duration-200">
                            View Tickets
                        </button>
                        <button id="resolvedTicketsTab"
                            class="px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 focus:outline-none transition-colors duration-200">
                            Resolved Tickets
                        </button>
                    </nav>
                </div>

                <!-- Form Content -->
                <div class="p-6 sm:p-8">
                    <!-- Create Tab Content -->
                    <div id="createTabContent">
                        <!-- Branch and Employee Info -->


                        <!-- Form -->
                        <form id="ticketForm" class="space-y-6">

                            <div class="mb-6">
                                <div class="text-sm text-gray-600 mb-1">
                                    <span class="font-medium text-gray-800">Branch Name & Code :</span>
                                    <span class="font-medium text-gray-800" id="branchname"></span> & <span
                                        class="font-medium text-gray-800" id="branchcode"></span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    Employee Name & Code : <span id="employeeName"></span> & <span
                                        id="employeecode"></span>
                                </div>
                            </div>
                            <!-- Client Code -->
                            <div>
                                <input type="text" id="clientCode" placeholder="Client Code"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 placeholder-gray-500"
                                    onkeypress="return /[A-Za-z0-9]/.test(event.key)"
                                    oninput="this.value = this.value.toUpperCase()"
                                    onpaste="this.value = this.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase()">

                            </div>



                            <!-- Category Dropdown -->
                            <div>
                                <select id="category"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 bg-white appearance-none">
                                    <option value="" disabled selected>Select Category</option>
                                    <option value="account">Account Details</option>
                                    <option value="brokerage">Brokerage & Other Charges</option>
                                    <option value="funds">Funds & Account Balance</option>
                                    <option value="ipo">IPO, OFS</option>
                                    <option value="margin">Margin Pledge & Margin Trading Facility</option>
                                    <option value="mf">Mutual Funds</option>
                                    <option value="onboarding">Onboarding</option>
                                    <option value="orders">Orders Related</option>
                                    <option value="portfolio">Portfolio & Corporate Actions</option>
                                    <option value="research">Research</option>
                                    <option value="statements">Statements</option>
                                </select>

                            </div>

                            <!-- Sub Category Dropdown -->
                            <div>
                                <select id="subCategory"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 bg-white appearance-none"
                                    disabled>
                                    <option value="" disabled selected>Select Sub Category</option>
                                </select>
                            </div>

                            <!-- Subject -->
                            <div>
                               <input type="text" id="subject" placeholder="Subject"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 placeholder-gray-500"
                                onkeypress="return /[A-Za-z0-9 ]/.test(event.key)"
                                oninput="this.value = this.value.replace(/[^A-Za-z0-9 ]/g, '').toUpperCase()"
                                onpaste="setTimeout(() => this.value = this.value.replace(/[^A-Za-z0-9 ]/g, '').toUpperCase(), 0)">

                            </div>
                            <div class="full mx-auto">
                                <div id="editor">


                                </div>
                            </div>

                            <!-- File Upload -->
                            <div>
                                <div
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-goodwill-blue transition-colors duration-200">
                                    <div class="flex flex-col items-center">
                                        <svg class="w-12 h-8 text-goodwill-blue mb-4" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p class="text-goodwill-blue font-medium mb-2">Browse file to upload</p>
                                        <p class="text-sm text-gray-500">Drag and drop files here or click to browse</p>
                                        <input type="file" id="fileUpload" class="hidden"
                                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                                    </div>
                                </div>

                                <!-- Uploaded Files List -->
                                <div id="uploadedFiles" class="mt-4 space-y-1 hidden">
                                    <!-- Uploaded files will be displayed here -->
                                </div>
                            </div>

                            <div class="w-full h-14">
                                <div class="w-full px-2 py-2 rounded-lg bg-red-100 text-red-500 hidden"
                                    id="invalidclientcode">
                                    <p class="text-red-500 text-sm leading-4 text-center"> Could you please verify the
                                        mapping? The client code doesn't seem to be linked to your branch. </p>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div>
                                <button type="submit" id="createtokenbtn"
                                    class="w-full bg-goodwill-blue text-white py-3 px-6 rounded-lg font-medium hover:bg-goodwill-dark-blue focus:outline-none focus:ring-2 focus:ring-goodwill-blue focus:ring-offset-2  active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    disabled>
                                    Create Ticket
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- View Tickets Tab Content -->
                    <div id="viewTicketsTabContent" class="hidden">
                        <!-- Search Bar -->
                        <div class="mb-6">
                            <div class="relative mb-4">
                                <input type="text" id="searchClientCode" placeholder="Search by Client Code"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 placeholder-gray-500"
                                    oninput="filterClientCode(this.value)">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>

                            <!-- Error Message (Hidden by Default) -->
                            <div id="clientCodeError" class="hidden p-4 mb-4 text-red-600 bg-red-50 rounded-lg">
                                ❌ Client Code not found!
                            </div>
                        </div>

                        <div id="noticket" class="w-full p-1 hidden">
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Resolved Tickets</h3>
                                <p class="text-gray-500">Resolved tickets will appear here once they are completed.</p>
                            </div>
                        </div>
                        <!-- Tickets List -->
                        <div class="space-y-4 hidden" id="ticketsList">






                        </div>
                    </div>


                    <!-- Resolved Tickets Tab Content -->
                    <div id="resolvedTicketsTabContent" class="hidden">
                        <div class="text-center py-12 hidden" id="ticketclosedno">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Resolved Tickets</h3>
                            <p class="text-gray-500">Resolved tickets will appear here once they are completed.</p>
                        </div>

                        <div class="w-full hidden" id="closedtickets">
                            <div class="mb-6">
                                <div class="relative mb-4">
                                    <input type="text" id="searchClosedClientCode" placeholder="Search by Client Code"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-goodwill-blue focus:border-transparent outline-none transition-all duration-200 text-gray-900 placeholder-gray-500"
                                        oninput="closefilterClientCode(this.value)">
                                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div id="clientCodeErrorclose"
                                    class="hidden p-4 mb-4 text-red-600 bg-red-50 rounded-lg">
                                    ❌ Client Code not found!
                                </div>
                            </div>

                            <div class="w-full p-1" id="closeaccordion"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 transform transition-all duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2" id="success"></h3>
                <p class="text-center text-gray-500 text-lg" style="margin-top: -13px;">Ticket No:<span
                        id="ticketid"></span></p>

                <button id="closeModal"
                    class="bg-goodwill-blue mt-2 text-white px-4 py-2 rounded-lg hover:bg-goodwill-dark-blue transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 transform transition-all duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.29 3.86L1.82 18a1 1 0 0 0 .86 1.5h18.64a1 1 0 0 0 .86-1.5L13.71 3.86a1 1 0 0 0-1.72 0zM12 9v4m0 4h.01" />
                    </svg>

                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2" id="error"></h3>
                <p class="text-center" id="ticketid"></p>

                <button id="closeModalerror"
                    class="bg-goodwill-blue text-white px-4 py-2 rounded-lg hover:bg-goodwill-dark-blue transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    <!-- Ticket Details Modal -->
    <div id="ticketModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div
            class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="closeTicketModal()"
                            class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h2 class="text-lg font-semibold text-gray-900" id="modalTicketNumber">#7084972</h2>
                    </div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Original Message -->

                <div id="messagereplaytemp" class="w-full p-1" >

                </div>


               

                <!-- Support Response -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div
                            class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium text-gray-900">Support</h3>
                            </div>
                            <div class="bg-white rounded p-3 mb-2">
                                <p class="text-sm text-gray-700">Your ticket has been created successfully. Our support
                                    team will get back to you in 24-48</p>
                                <p class="text-xs text-gray-500"><span id="date"></span> <span id="time"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full mt-2" id="revokecontainer">

                </div>

                <!-- Reply Form -->
                <div class="border-t pt-6" id="closenonecontent">
                    <form id="replyForm" class="space-y-4">

                        <input type="text" name="" class="hidden" id="repclientcode">
                        <input type="text" name="" class="hidden" id="repticketno">

                        <div class="full mx-auto">
                            <div id="editor2">


                            </div>
                        </div>
                        <!-- File Upload for Reply -->
                        <!-- Replace the existing reply file upload section with this -->
                        <div>
                            <div
                                class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-goodwill-blue transition-colors duration-200">
                                <div class="flex flex-col items-center">
                                    <svg class="w-12 h-8 text-goodwill-blue mb-4" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="text-goodwill-blue font-medium mb-2">Browse file to upload</p>
                                    <p class="text-sm text-gray-500">Drag and drop files here or click to browse</p>
                                    <input type="file" id="replyFileUpload" class="hidden"
                                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                                </div>
                            </div>

                            <!-- Uploaded Files List -->
                            <div id="replyUploadedFiles" class="mt-4 space-y-1 hidden">
                                <!-- Uploaded files will be displayed here -->
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <button type="submit" disabled id="replaybtn"
                            class="w-full bg-goodwill-blue text-white py-3 px-6 rounded-lg font-medium hover:bg-goodwill-dark-blue focus:outline-none focus:ring-2 focus:ring-goodwill-blue focus:ring-offset-2 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            Reply & Submit
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewerModal"
        class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-60 hidden">
        <div class="relative max-w-4xl max-h-[90vh] w-full h-full flex items-center justify-center p-4">
            <!-- Close Button -->
            <button onclick="closeImageViewer()"
                class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors duration-200 z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <!-- Image Container -->
            <div class="relative max-w-full max-h-full">
                <img id="viewerImage"
                    
                    alt="Attachment" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">

                <!-- Image Info -->
               



            </div>



        </div>
    </div>



    
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);

            document.getElementById('branchname').innerText = `${urlParams.get('branchname')}`;
            document.getElementById('branchcode').innerText = `${urlParams.get('branchcode')}`;
            document.getElementById('employeeName').innerText = `${urlParams.get('empName')}`;

            document.getElementById('employeecode').innerText = `${urlParams.get('empCode')}`


        };

        const quill = new Quill('#editor', {
            theme: 'snow',

            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],

                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],



                    ['link']
                ]
            }
        });


        const quill2 = new Quill('#editor2', {
            theme: 'snow',

            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],

                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],



                    ['link']
                ]
            }
        });

        document.getElementById('createtokenbtn').disabled = true;

        function clientEncryption(input) {
            const secretKey = 'J0E';
            const secretIv = 'rLv';

            // Get 16 bytes from SHA256 for key and IV
            const key = CryptoJS.SHA256(CryptoJS.enc.Utf8.parse(secretKey)).words.slice(0, 4); // 4 words = 16 bytes
            const iv = CryptoJS.SHA256(CryptoJS.enc.Utf8.parse(secretIv)).words.slice(0, 4);

            const keyWA = CryptoJS.lib.WordArray.create(key, 16);
            const ivWA = CryptoJS.lib.WordArray.create(iv, 16);

            const encrypted = CryptoJS.AES.encrypt(input, keyWA, {
                iv: ivWA,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });

            // Return only base64 of ciphertext (like PHP with OPENSSL_RAW_DATA)
            return CryptoJS.enc.Base64.stringify(encrypted.ciphertext);
        }

        // Get current date in yyyy-mm-dd format
        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Use it with your encryption function
        const enc = clientEncryption(getCurrentDate());



      let isClientCodeValid = false;
const clientcodecheck = document.getElementById('clientCode');
const clienterror = document.getElementById('invalidclientcode');

// ✅ When user focuses (clicks into) the input
clientcodecheck.addEventListener('focus', function () {
    clienterror.classList.add('hidden');
    clientcodecheck.classList.remove('border-red-500', 'focus:ring-red-500');
    clientcodecheck.classList.add('border-gray-300', 'focus:ring-goodwill-blue');
});

// ✅ When user blurs (clicks out of) the input
clientcodecheck.addEventListener('blur', async function () {
    const clientCode = clientcodecheck.value.trim();
    const formData = new FormData();
    formData.append('ticket', enc);

    if (clientCode) {
        try {
            const apiurl = `https://smartpayz.gwcindia.in/gwc-techexcel/client-master-techexcel-live.php?src=SMARTPAY&key=${encodeURIComponent(enc)}&ticket=${enc}&cid=${clientCode}`;

            const response = await fetch(apiurl, { method: 'GET' });
            const data = await response.json();

            const branchurlParams = new URLSearchParams(window.location.search);

            if (data.BranchCode === branchurlParams.get('branchcode')) {
                clienterror.classList.add('hidden');
                isClientCodeValid = true;
                clientcodecheck.classList.remove('border-red-500', 'focus:ring-red-500');
                clientcodecheck.classList.add('border-gray-300', 'focus:ring-goodwill-blue');
            } else {
                clienterror.classList.remove('hidden');
                isClientCodeValid = false;
                clientcodecheck.classList.remove('border-gray-300', 'focus:ring-goodwill-blue');
                clientcodecheck.classList.add('border-red-500', 'focus:ring-red-500');
            }

        } catch (error) {
            clienterror.classList.remove('hidden');
            clientcodecheck.classList.remove('border-gray-300', 'focus:ring-goodwill-blue');
            clientcodecheck.classList.add('border-red-500', 'focus:ring-red-500');
            isClientCodeValid = false;
        }
    } else {
        clienterror.classList.remove('hidden');
        clientcodecheck.classList.remove('border-gray-300', 'focus:ring-goodwill-blue');
        clientcodecheck.classList.add('border-red-500', 'focus:ring-red-500');
        isClientCodeValid = false;
    }

    validateForm();
});

        // Function to check if all required fields are filled
        function validateForm() {
            const clientCode = document.getElementById('clientCode').value.trim();
            const category = document.getElementById('category').value;
            const subCategory = document.getElementById('subCategory').value;
            const subject = document.getElementById('subject').value.trim();
            const editorContent = quill.root.innerHTML.trim();
            const branchname = document.getElementById('branchname').innerText.trim();
            const employeeName = document.getElementById('employeeName').innerText.trim();
            const branchcode = document.getElementById('branchcode').innerText.trim();
            const employeeCode = document.getElementById('employeecode').innerText.trim();

            const isValid = (
                clientCode !== '' &&
                isClientCodeValid && // ✅ Check if client code is valid
                category !== '' &&
                subCategory !== '' &&
                subject !== '' &&
                editorContent !== '<p><br></p>' &&
                branchname !== '' &&
                employeeName !== '' &&
                branchcode !== '' &&
                employeeCode !== ''
            );

            document.getElementById('createtokenbtn').disabled = !isValid;
            return isValid;
        }
        // Add direct event listeners without debouncing
        document.getElementById('clientCode').addEventListener('input', validateForm);
        document.getElementById('category').addEventListener('change', validateForm);
        document.getElementById('subCategory').addEventListener('change', validateForm);
        document.getElementById('subject').addEventListener('input', validateForm);
        quill.on('text-change', validateForm);

        // Initial validation
        validateForm();

        const categorySelect = document.getElementById('category');
        const subCategorySelect = document.getElementById('subCategory');
        const fileUpload = document.getElementById('fileUpload');
        const ticketForm = document.getElementById('ticketForm');
        const successModal = document.getElementById('successModal');
        const errorModal = document.getElementById('errorModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalerror = document.getElementById('closeModalerror');
        const searchClientCode = document.getElementById('searchClientCode');





        // Fetch subcategories from API and initialize dropdowns
        const initializeDropdowns = async () => {
            try {
                const response = await fetch('https://g1.gwcindia.in/ticket-api/ticket-category-subcategory.php');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const categorySelect = document.getElementById('category');
                const subCategorySelect = document.getElementById('subCategory');

                // Create mapping between HTML values and API category names
                const categoryMap = {
                    'account': 'Account Details',
                    'brokerage': 'Brokerage & Other Charges',
                    'funds': 'Funds & Account Balance',
                    'ipo': 'IPO, OFS',
                    'margin': 'Margin Pledge & Margin Trading Facility',
                    'mf': 'Mutual Funds',
                    'onboarding': 'Onboarding',
                    'orders': 'Order Related',
                    'portfolio': 'Portfolio & Corporate Actions',
                    'research': 'Research',
                    'statements': 'Statements'
                };

                // Handle category change
                categorySelect.addEventListener('change', function () {
                    const selectedValue = this.value;
                    const apiCategoryName = categoryMap[selectedValue];

                    // Find the category data in the API response
                    const categoryData = data.find(item => item && typeof item === 'object' && item[apiCategoryName]);

                    const subCats = categoryData ? categoryData[apiCategoryName] : [];

                    // Clear and populate sub-category dropdown
                    subCategorySelect.innerHTML = '<option value="" disabled selected>Select Sub Category</option>';

                    subCats.forEach(subCat => {
                        const option = document.createElement('option');
                        option.value = subCat.toLowerCase().replace(/\s+/g, '-');
                        option.textContent = subCat;
                        subCategorySelect.appendChild(option);
                    });

                    // Enable sub-category dropdown
                    subCategorySelect.disabled = false;
                });

            } catch (error) {
                console.error('Error fetching subcategories:', error);
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeDropdowns);


        // Tab functionality
        const tabs = {
            create: document.getElementById('createTab'),
            viewTickets: document.getElementById('viewTicketsTab'),
            resolvedTickets: document.getElementById('resolvedTicketsTab')
        };

        const tabContents = {
            create: document.getElementById('createTabContent'),
            viewTickets: document.getElementById('viewTicketsTabContent'),
            resolvedTickets: document.getElementById('resolvedTicketsTabContent')
        };

        // Initialize tab functionality
        Object.entries(tabs).forEach(([key, tab]) => {
            tab.addEventListener('click', () => switchTab(key));
        });

        function switchTab(activeTab) {

            if (activeTab == 'viewTickets') {
                openTicket()
            }

            if (activeTab == 'resolvedTickets') {
                closefetchdata()
            }
            // Reset all tabs
            Object.values(tabs).forEach(tab => {
                tab.className = 'px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 focus:outline-none transition-colors duration-200';
            });

            // Activate selected tab
            tabs[activeTab].className = 'px-6 py-4 text-sm font-medium text-white bg-goodwill-blue border-b-2 border-goodwill-blue focus:outline-none transition-colors duration-200';

            // Hide all tab contents
            Object.values(tabContents).forEach(content => {
                content.classList.add('hidden');
            });

            // Show active tab content
            tabContents[activeTab].classList.remove('hidden');
        }





        const uploadedFilesList = [];
        // File upload functionality
        const uploadArea = fileUpload.parentElement.parentElement;
        const uploadedFiles = document.getElementById('uploadedFiles');

        // Global variable to store the single uploaded file
        let currentUploadedFile = null;
        uploadArea.addEventListener('click', () => fileUpload.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-goodwill-blue', 'bg-blue-50');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-goodwill-blue', 'bg-blue-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-goodwill-blue', 'bg-blue-50');

            const files = Array.from(e.dataTransfer.files);
            if (files.length > 1) {
               
                return;
            }
            handleFiles(files);
        });

        fileUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            // Clear previous upload
            uploadedFiles.innerHTML = "";
            currentUploadedFile = null;

            // Process the new file
            const file = files[0]; // Take only the first file (in case multiple were selected)
            const fileItem = createFileItem(file);
            uploadedFiles.appendChild(fileItem);
            uploadedFiles.classList.remove('hidden');

            // Read file as base64 and store it globally
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64String = e.target.result.split(',')[1]; // Remove data URL prefix
                currentUploadedFile = {
                    fileName: file.name,
                    fileContent: base64String,
                    fileSize: file.size,
                    fileType: file.type
                };
                // For debugging
            };
            reader.readAsDataURL(file);
        }


        function createFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';

            fileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)} - Uploaded</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `;

            return fileItem;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }




        const createticket = async () => {
            const apiurl = 'https://g1.gwcindia.in/ticket-api/create-ticket-br-emp.php';
            const header = '6f584292813dcf325e4846b4a9913504091b9d0323d8057d7a1e27d351f9f46e2aeae512b7943b0e';

            const categorieselementvalue = {
                'account': '1',
                'brokerage': '2',
                'funds': '3',
                'ipo': '4',
                'margin': '5',
                'mf': '6',
                'onboarding': '7',
                'orders': '8',
                'portfolio': '9',
                'research': '10',
                'statements': '11'
            };

            const dept = categorieselementvalue[document.getElementById('category').value];
            const content = quill.root.innerHTML;
            const posturlparams = new URLSearchParams(window.location.search);

            const formData = new FormData();
            formData.append('department', dept);
            formData.append('text', content);
            formData.append('empcode', posturlparams.get('empCode'));
            formData.append('subject', document.getElementById('subject').value);
            formData.append('branchCode', posturlparams.get('branchcode'));
            formData.append('subcat', document.getElementById('subCategory').value);
            formData.append('clientCode', document.getElementById('clientCode').value);

            // Only append filename and attachment if a file exists
            if (currentUploadedFile) {
                formData.append('filename', currentUploadedFile.fileName);
                formData.append('attachment', currentUploadedFile.fileContent);
            }

            try {
                const response = await fetch(apiurl, {
                    method: 'POST',
                    headers: {
                        'Authorization': header
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const dataval = await response.json();
                if (dataval.status == 'ok') {
                    // Show success modal
                    successModal.classList.remove('hidden');
                    successModal.querySelector('.transform').classList.remove('scale-95');
                    successModal.querySelector('.transform').classList.add('scale-100');

                    document.getElementById('success').innerText = dataval.message
                    document.getElementById('ticketid').innerText = dataval.data.ticket_no
                }
                else if (dataval.status == 'error') {

                    errorModal.classList.remove('hidden');
                    errorModal.querySelector('.transform').classList.remove('scale-95');
                    errorModal.querySelector('.transform').classList.add('scale-100');

                    document.getElementById('error').innerText = dataval.message
                }
            } catch (error) {
                console.error('Error:', error);

            }
        };
        // Form submission
        ticketForm.addEventListener('submit', function (e) {
            e.preventDefault();
            createticket()




        });

        // Close modal
        closeModal.addEventListener('click', function () {
            successModal.classList.add('hidden');
            switchTab('viewTickets')
        });

        // Close modal when clicking outside
        successModal.addEventListener('click', function (e) {
            if (e.target === successModal) {
                successModal.classList.add('hidden');
            }
        });

        closeModalerror.addEventListener('click', function () {
            errorModal.classList.add('hidden');
            document.getElementById('clientCode').value = ''
            document.getElementById('subject').value = ''
            document.getElementById('category').value = ''
            document.getElementById('subCategory').value = ''
            quill.root.innerHTML = '';
            quill.setText('');

            fileUpload.value = '';

            // Clear the uploaded file display
            uploadedFiles.innerHTML = "";
            uploadedFiles.classList.add('hidden');

            // Clear the global file reference
            currentUploadedFile = null;

            // Reset the upload area styling
            uploadArea.classList.remove('border-goodwill-blue', 'bg-blue-50');

        })

        closeModalerror.addEventListener('click', function (e) {
            if (e.target === closeModalerror) {
                closeModalerror.classList.add('hidden');
            }
        });

        document.getElementById('replaybtn').disabled = true
        async function openTicket() {
            document.getElementById('closenonecontent').classList.remove('hidden')
            document.getElementById('revokecontainer').classList.add('hidden')
            try {
                const ticketbranchparam = new URLSearchParams(window.location.search);
                const branchCode = ticketbranchparam.get('branchcode');

                const apiUrl = `https://g1.gwcindia.in/ticket-api/br-emp-tickets.php?ticket_status=open&createdBy=BRANCH-EMP&usercode=${branchCode}`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                if (data.status == 'ok' && data.count > 0) {
                
                    document.getElementById('ticketsList').classList.remove('hidden')

                    accordianlist(data)
                }
                else if (data.count == 0) {

                    document.getElementById('noticket').classList.remove('hidden')
                }

            } catch (error) {
                console.error("Error fetching tickets:", error);
            }
        }

        openTicket()

        let ticketMap = {};

        function accordianlist(datavalue) {
            const tickets = datavalue.tickets;

            // Group tickets by clientCode
            ticketMap = {};
            tickets.forEach((item) => {
                if (item.clientCode) {
                    if (!ticketMap[item.clientCode]) {
                        ticketMap[item.clientCode] = [];
                    }
                    ticketMap[item.clientCode].push(item);
                }
            });

            // Initial render (show all)
            filterClientCode("");
        }
        function toggleTicketDetails(id) {
            const details = document.getElementById(`details-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            const isOpen = !details.classList.contains('hidden');

            if (isOpen) {
                details.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            } else {
                details.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            }
        }

        function filterClientCode(searchTerm) {
            const container = document.getElementById('ticketsList');
            const errorMsg = document.getElementById('clientCodeError');
            searchTerm = searchTerm.trim().toUpperCase();

            container.innerHTML = '';
            errorMsg.classList.add('hidden');

            if (searchTerm === "") {
                renderAllAccordions();
                return;
            }

            // Filter client codes that START WITH search term
            const matchingClients = Object.keys(ticketMap).filter(
                clientCode => clientCode.startsWith(searchTerm)
            );

            if (matchingClients.length > 0) {
                // Render matching clients as accordions
                matchingClients.forEach(clientCode => {
                    renderClientAccordion(clientCode);
                });
            } else {
                errorMsg.classList.remove('hidden');
            }
        }

        function renderClientAccordion(clientCode) {
            const container = document.getElementById('ticketsList');
            const clientTickets = ticketMap[clientCode];
            const uniqueId = `client-${clientCode.replace(/\W/g, '')}`;

            const ticketsHtml = clientTickets.map(ticket => `
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between" onclick="openTicketModal('${ticket.ticketNo}','${clientCode}', '${ticket.createdDate}', '${ticket.createdTime}')">
                <span class="ml-2 text-gray-500 cursor-pointer"
                      >
                    #${ticket.ticketNo}
                </span>
                <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">Open</span>
            </div>
        </div>
    `).join('');

            const accordionHtml = `
        <div class="bg-gray-50 rounded-lg border border-gray-200 mb-2">
            <div class="p-4 cursor-pointer" onclick="toggleTicketDetails('${uniqueId}')">
                <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-700">${clientCode}</span>
                   
                
                    <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-200"  id="arrow-${uniqueId}" >
                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                </div>
            </div>
            <div class="hidden border-t border-gray-200 bg-white" id="details-${uniqueId}">
                ${ticketsHtml}
            </div>
        </div>
    `;

            container.insertAdjacentHTML('beforeend', accordionHtml);
            container.classList.remove('hidden');
        }
        function renderAllAccordions() {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '';
            container.classList.remove('hidden');

            Object.entries(ticketMap).forEach(([clientCode, clientTickets]) => {
                const uniqueId = `client-${clientCode.replace(/\W/g, '')}`;
                const detailsId = `details-${uniqueId}`;
                const arrowId = `arrow-${uniqueId}`;

                const ticketsHtml = clientTickets.map(ticket => `
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center justify-between cursor-pointer"   onclick="openTicketModal('${ticket.ticketNo}','${clientCode}', '${ticket.createdDate}', '${ticket.createdTime}')">
                    <div>
                        <span class="ml-2 text-gray-500 ">
                            #${ticket.ticketNo}
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">Open</span>
                </div>
            </div>
        `).join('');

                const accordionHtml = `
            <div class="bg-gray-50 rounded-lg border border-gray-200 mb-2">
                <div class="p-4 cursor-pointer" onclick="toggleTicketDetails('${uniqueId}')">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-700">${clientCode}</span>
                      

                           <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-200" id="${arrowId}">
                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                    </div>
                </div>
                <div class="hidden border-t border-gray-200 bg-white" id="${detailsId}">
                    ${ticketsHtml}
                </div>
            </div>
        `;

                container.insertAdjacentHTML('beforeend', accordionHtml);
            });
        }

        function renderSingleAccordion(clientCode) {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '';
            container.classList.remove('hidden');

            const clientTickets = ticketMap[clientCode];
            const uniqueId = `client-${clientCode.replace(/\W/g, '')}`;
            const detailsId = `details-${uniqueId}`;
            const arrowId = `arrow-${uniqueId}`;

            const ticketsHtml = clientTickets.map(ticket => `
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between" onclick="openTicketModal('${ticket.ticketNo}','${clientCode}', '${ticket.createdDate}', '${ticket.createdTime}')">
                <div>
                  <span class="ml-2 text-gray-500 cursor-spanointer">
                       #${ticket.ticketNo}
                    </span>
                </div>
                <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">Open</span>
            </div>
        </div>
    `).join('');

            const accordionHtml = `
        <div class="bg-gray-50 rounded-lg border border-gray-200 mb-2">
            <div class="p-4 cursor-pointer" onclick="toggleTicketDetails('${uniqueId}')">
                <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-700">${clientCode}</span>
                    <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-200" id="${arrowId}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
            <div class="hidden border-t border-gray-200 bg-white" id="${detailsId}">
                ${ticketsHtml}
            </div>
        </div>
    `;

            container.insertAdjacentHTML('beforeend', accordionHtml);
        }


        function openTicketModal(ticketNumber, clientCode, date, time) {

            ticketviewimage(ticketNumber, clientCode)

            const modal = document.getElementById('ticketModal');
            const modalTicketNumber = document.getElementById('modalTicketNumber');
            const modalClientCode = document.getElementById('modalClientCode');
            const modalClientFullCode = document.getElementById('modalClientFullCode');
            const modalTicketId = document.getElementById('modalTicketId');
            const datec = document.getElementById('date');
            const timec = document.getElementById('time');
            const viewimage = document.getElementById('viewattached');
            document.getElementById('repclientcode').value = clientCode
            document.getElementById('repticketno').value = ticketNumber

            // Update modal content
            modalTicketNumber.textContent ='#'+ ticketNumber;
     
            datec.textContent = date;
            timec.textContent = time;

        
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.transform').classList.remove('scale-95');
                modal.querySelector('.transform').classList.add('scale-100');
            }, 10);
        }



        function replayvalidateForm() {
            const editorContent = quill2.root.innerHTML.trim();
            const isValid = (
                editorContent !== '<p><br></p>'
            )
            document.getElementById('replaybtn').disabled = !isValid;
            return isValid
        }

        quill2.on('text-change', replayvalidateForm);
        replayvalidateForm();

        async function ticketviewimage(ticketno, clientcode) {
            const apiurl = 'https://g1.gwcindia.in/ticket-api/get-ticket-status-messages.php';
            const formData = new FormData();
            formData.append('ticket_no', ticketno);
            formData.append('clientcode', clientcode);

            try {
                const response = await fetch(apiurl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                if (data.status == 'ok') {
                    messagerender(data, clientcode, ticketno)
                }

             

                return data;
            } catch (error) {
                console.error('Error fetching ticket view image:', error);
            }
        }

        function messagerender(messagerender, clientcodev, ticketval) {
            const ticketmessage = messagerender.data;
            const messagediv = document.getElementById('messagereplaytemp');

            // Clear existing messages
            messagediv.innerHTML = '';

            ticketmessage.forEach(item => {
                const cardcolor = item.by; // 0 or 1
                const hasAttachment = item.attachments && item.attachments.length > 0;
                const attachmentUrl = hasAttachment ? item.attachments[0].direct_frontend_url : null;
            const timestamp = item.created_at; // e.g., 1752663181


// Convert seconds to milliseconds
const dateObj = new Date(timestamp * 1000);


// Format the date
const formattedDate = dateObj.toLocaleString('en-IN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
});


                
                                // Create a container div for each message
                const messageElement = document.createElement('div');
                messageElement.className = 'flex items-center space-x-3 p-2 mb-2 rounded-lg';

                // Conditionally set background color
                if (cardcolor == 0) {
                    messageElement.classList.add('bg-gray-50');
                } else if (cardcolor == 1) {
                    messageElement.classList.add('bg-blue-50');
                }

                const clientcodeint = clientcodev.charAt(0);

                // Build the HTML with or without the attachment block
                messageElement.innerHTML = `
            <div class="w-full px-2 py-2">
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-blue-600 font-medium text-md">${clientcodeint}</span>
                    </div>
                    <div class="flex-1 w-full" >
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-medium text-gray-900">${item.excerpt}</h3>
                             <p class="text-xs text-gray-500">${formattedDate}</p>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">${clientcodev}</span>
                            <span class="text-gray-400 ml-2">${ticketval}</span>
                            <p>${item.text}</p>
                        </div>
                     
                      ${attachmentUrl
                        ? `<div class="mt-2">
                <button type="button" onclick="openImageViewer('${attachmentUrl}')" class="text-blue-500 text-sm">
                    View Attachment
                </button>
           </div>`
                        : ''
                    }

                      
                    </div>
                </div>
            </div>
        `;

                messagediv.appendChild(messageElement);
            });
        }


        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            modal.querySelector('.transform').classList.remove('scale-100');
            modal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Close modal when clicking outside
        document.getElementById('ticketModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeTicketModal();
            }
        });

        // Reply form submission
        document.getElementById('replyForm').addEventListener('submit', function (e) {
            e.preventDefault();

            replaysendData()

            // closeTicketModal();
        });

        // Reply file upload functionality

        // Global variable to store the reply uploaded file
        let replyCurrentUploadedFile = null;
        const replyUploadArea = document.querySelector('#replyFileUpload').parentElement.parentElement;
        const replyUploadedFiles = document.getElementById('replyUploadedFiles');

        // Click handler
        replyUploadArea.addEventListener('click', () => document.getElementById('replyFileUpload').click());

        // Drag and drop handlers
        replyUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            replyUploadArea.classList.add('border-goodwill-blue', 'bg-blue-50');
        });

        replyUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            replyUploadArea.classList.remove('border-goodwill-blue', 'bg-blue-50');
        });

        replyUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            replyUploadArea.classList.remove('border-goodwill-blue', 'bg-blue-50');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 1) {
                return; // Only allow one file
            }
            handleReplyFiles(files);
        });

        // File input change handler
        document.getElementById('replyFileUpload').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleReplyFiles(files);
        });

        function handleReplyFiles(files) {
            if (files.length === 0) return;

            // Clear previous upload
            replyUploadedFiles.innerHTML = "";
            replyCurrentUploadedFile = null;

            // Process the new file
            const file = files[0];
            const fileItem = createReplyFileItem(file);
            replyUploadedFiles.appendChild(fileItem);
            replyUploadedFiles.classList.remove('hidden');

            // Read file as base64
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64String = e.target.result.split(',')[1];
                replyCurrentUploadedFile = {
                    fileName: file.name,
                    fileContent: base64String,
                    fileSize: file.size,
                    fileType: file.type
                };
            };
            reader.readAsDataURL(file);
        }

        function createReplyFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';

            fileItem.innerHTML = `
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                </svg>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-900">${file.name}</p>
                <p class="text-xs text-gray-500">${formatFileSize(file.size)} - Uploaded</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button type="button" class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove(); replyCurrentUploadedFile = null; if(replyUploadedFiles.children.length === 0) replyUploadedFiles.classList.add('hidden');">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    `;

            return fileItem;
        }
        function openImageViewer(imageurl) {
            document.getElementById('ticketModal').classList.add('hidden')
            const modal = document.getElementById('imageViewerModal');
            const image = document.getElementById('viewerImage');
            const imageName = document.getElementById('imageName');
            const imageSize = document.getElementById('imageSize');




            image.src = imageurl;


            // Show modal
            modal.classList.remove('hidden');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.classList.add('hidden');

            // Restore body scroll
            document.body.style.overflow = 'auto';
        }







        // Close image viewer when clicking outside the image
        document.getElementById('imageViewerModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeImageViewer();
            }
        });


        async function replaysendData() {
            const apiurl = 'https://g1.gwcindia.in/ticket-api/reply-ticket.php';
            const content = quill2.root.innerHTML;

            const formData = new FormData();

            // Make sure to collect these values from inputs or variables
            const branchparama = new URLSearchParams(window.location.search)

            formData.append('clientcode', document.getElementById('repclientcode').value);
            formData.append('ticket_no', document.getElementById('repticketno').value);
            formData.append('text', content);
            formData.append('branchCode', branchparama.get('branchcode'));



            if (replyCurrentUploadedFile) {
                formData.append('filename', replyCurrentUploadedFile.fileName);
                formData.append('attachment', replyCurrentUploadedFile.fileContent);
            }

            try {
                const response = await fetch(apiurl, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Reply sent response:', result);
                if (result.status == 'ok') {
                    ticketviewimage( document.getElementById('repticketno').value, document.getElementById('repclientcode').value)
                  
                }

                else if (result.status == 'error') {

                    errorModal.classList.remove('hidden');
                    errorModal.querySelector('.transform').classList.remove('scale-95');
                    errorModal.querySelector('.transform').classList.add('scale-100');

                    document.getElementById('error').innerText = result.message
                }


                // handle success/failure UI updates here
            } catch (error) {
                console.error('Error sending reply:', error);
            }
        }




        //    close section
        let closeticketMap = {};

        async function closefetchdata() {
            document.getElementById('closenonecontent').classList.add('hidden')
            document.getElementById('revokecontainer').classList.remove('hidden')
            const closeparams = new URLSearchParams(window.location.search);
            const branchCode = closeparams.get('branchcode');

            if (!branchCode) {
                console.error("branchcode parameter is missing in the URL");
                return;
            }

            const apiurl = `https://g1.gwcindia.in/ticket-api/br-emp-tickets.php?ticket_status=closed&createdBy=BRANCH-EMP&usercode=${branchCode}`;
            const header = '6f584292813dcf325e4846b4a9913504091b9d0323d8057d7a1e27d351f9f46e2aeae512b7943b0e';

            try {
                const response = await fetch(apiurl, {
                    method: 'GET',
                    headers: {
                        'Authorization': header,
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                if (data.status == 'ok' && data.count > 0) {

                    document.getElementById('closedtickets').classList.remove('hidden');
                    document.getElementById('ticketclosedno').classList.add('hidden');
                    
                    closeaccordianlist(data);

                    const rokebutton = document.getElementById('revokecontainer');

                    const button = document.createElement('button');
                    button.textContent = 'Revoke Ticket'; // Set button text
                    button.className = 'px-4 py-2 bg-blue-600 w-full text-white rounded-xl hover:bg-blue-700'; // Tailwind classes or your styles
                    button.onclick = function () {
                        alert('Revoke action triggered!');
                        // You can call any function here
                    };

                    rokebutton.appendChild(button);
                } else if (data.count == 0) {
                    document.getElementById('ticketclosedno').classList.remove('hidden');
                    document.getElementById('closedtickets').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching resolved tickets:', error);
            }
        }

        function closeaccordianlist(datavalue) {
            const tickets = datavalue.tickets;
             // Add button to the container


            // Group tickets by clientCode
            closeticketMap = {};
            tickets.forEach((item) => {
                if (item.clientCode) {
                    if (!closeticketMap[item.clientCode]) {
                        closeticketMap[item.clientCode] = [];
                    }
                    closeticketMap[item.clientCode].push(item);
                }
            });

            // Initial render (show all)
            closefilterClientCode("");
        }

       function closetoggleTicketDetails(id) {
    const details = document.getElementById(`closedetails-${id}`);
    const arrow = document.getElementById(`closearrow-${id}`);
    const isOpen = !details.classList.contains('hidden');

    if (isOpen) {
        details.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    } else {
        details.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    }
}


        function closefilterClientCode(searchTerm) {
            const container = document.getElementById('closeaccordion');
            const errorMsg = document.getElementById('clientCodeErrorclose');
            searchTerm = searchTerm.trim().toUpperCase();

            container.innerHTML = '';
            errorMsg.classList.add('hidden');

            if (searchTerm === "") {
                closerenderAllAccordions();
                return;
            }

            // Filter client codes that START WITH search term
            const matchingClients = Object.keys(closeticketMap).filter(
                clientCode => clientCode.startsWith(searchTerm)
            );

            if (matchingClients.length > 0) {
                // Render matching clients as accordions
                matchingClients.forEach(clientCode => {
                    closerenderClientAccordion(clientCode);
                });
            } else {
                errorMsg.classList.remove('hidden');
            }
        }

        function closerenderClientAccordion(clientCode) {
            const container = document.getElementById('closeaccordion');
            const clientTickets = closeticketMap[clientCode];
            const uniqueId = `client-${clientCode.replace(/\W/g, '')}`;

            const ticketsHtml = clientTickets.map(ticket => `
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between cursor-pointer"  onclick="openTicketModal('${ticket.ticketNo}','${clientCode}', '${ticket.createdDate}', '${ticket.createdTime}')">
                <span class="ml-2 text-gray-500 ">
                    #${ticket.ticketNo}
                </span>
                <span class="px-3 py-1 bg-red-100 text-red-500 text-sm font-medium rounded-full">Closed</span>
            </div>
        </div>
      `).join('');

            const accordionHtml = `
        <div class="bg-gray-50 rounded-lg border border-gray-200 mb-2">
            <div class="p-4 cursor-pointer" onclick="closetoggleTicketDetails('${uniqueId}')">
    <div class="flex items-center justify-between">
        <span class="font-medium text-gray-700">${clientCode}</span>
     

         <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-200" id="closearrow-${uniqueId}">
                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
    </div>
</div>

            <div class="hidden border-t border-gray-200 bg-white" id="closedetails-${uniqueId}">
                ${ticketsHtml}
            </div>
        </div>


    `
    
    ;

            container.insertAdjacentHTML('beforeend', accordionHtml);
        }

        function closerenderAllAccordions() {
            const container = document.getElementById('closeaccordion');
            container.innerHTML = '';

            Object.entries(closeticketMap).forEach(([clientCode, clientTickets]) => {
                const uniqueId = `client-${clientCode.replace(/\W/g, '')}`;
                const detailsId = `closedetails-${uniqueId}`;
                const arrowId = `closearrow-${uniqueId}`;

                const ticketsHtml = clientTickets.map(ticket => `
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center justify-between cursor-pointer"   onclick="openTicketModal('${ticket.ticketNo}','${clientCode}', '${ticket.createdDate}', '${ticket.createdTime}')">
                    <div>
                        <span class="ml-2 text-gray-500 ">
                            #${ticket.ticketNo}
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-red-100 text-red-500 text-sm font-medium rounded-full">Closed</span>
                </div>
            </div>
        `).join('');

                const accordionHtml = `
            <div class="bg-gray-50 rounded-lg border border-gray-200 mb-2">
                <div class="p-4 cursor-pointer" onclick="closetoggleTicketDetails('${uniqueId}')">
    <div class="flex items-center justify-between">
        <span class="font-medium text-gray-700">${clientCode}</span>
       

         <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-200" id="closearrow-${uniqueId}">
                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
    </div>
</div>

                <div class="hidden border-t border-gray-200 bg-white" id="${detailsId}">
                    ${ticketsHtml}
                </div>
            </div>
        `;

                container.insertAdjacentHTML('beforeend', accordionHtml);
            });
        }

    </script>
</body>

</html>